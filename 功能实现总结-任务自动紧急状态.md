# 任务自动紧急状态功能 - 实现总结

## ✅ 已实现的功能

### 核心逻辑

当满足以下条件时，任务会**自动**被标记为紧急（`urgent = true`）：

1. 任务有截止时间（`deadline !== null`）
2. 任务未完成（`completed === false`）
3. **剩余时间 < 24小时**（包括已超时的任务）

公式：`剩余时间 = 截止时间 - 当前时间`

### 自动触发时机

#### 1. 应用加载时 ✅

- **位置**：`App.vue` 的 `loadTasks()` 函数
- **触发**：页面刷新、首次打开应用
- **效果**：从 localStorage 加载任务后，自动更新所有任务的紧急状态

#### 2. 添加新任务时 ✅

- **位置**：`misson_l.vue` 的 `addTask()` 函数
- **触发**：用户点击"添加任务"→"确认"
- **效果**：根据截止时间自动设置新任务的紧急状态
- **日志**：控制台会显示 `🔥 任务 "xxx" 自动设为紧急 (剩余 X.XX 小时)`

#### 3. 编辑任务时 ✅

- **位置**：`misson_l.vue` 的 `updateTask()` 函数
- **触发**：用户编辑任务并保存
- **效果**：
  - 修改截止时间后自动重新计算紧急状态
  - 移除截止时间会自动取消紧急状态
- **日志**：
  - `🔥 任务 "xxx" 自动设为紧急 (剩余 X.XX 小时)`
  - `✅ 任务 "xxx" 取消紧急状态（无截止时间）`

#### 4. 定期自动检查 ✅

- **位置**：`App.vue` 的定时器
- **触发**：每5分钟自动执行
- **效果**：批量检查所有任务，更新紧急状态
- **日志**：
  - `🔍 检查任务紧急状态...`
  - `🔥/✅ "任务名" 紧急状态: false → true`
  - `✨ X 个任务的紧急状态已更新`

#### 5. 窗口焦点恢复时 ✅

- **位置**：`App.vue` 的 focus 事件监听器
- **触发**：用户切换回应用窗口
- **效果**：自动检查任务紧急状态（因为可能在其他窗口工作了一段时间）

## 📁 修改的文件

### 1. 新增文件

#### `src/utils/taskUrgency.ts`

核心工具函数：

- `shouldBeUrgent(task)` - 判断任务是否应该紧急
- `updateTaskUrgency(task)` - 更新单个任务
- `updateTasksUrgency(tasks)` - 批量更新任务列表

#### `src/utils/__tests__/taskUrgency.spec.ts`

完整的单元测试（10个测试用例全部通过）

#### `src/utils/README_taskUrgency.md`

功能文档和使用说明

#### `测试指南-任务自动紧急状态.md`

测试场景和调试技巧

### 2. 修改的文件

#### `App.vue`

```typescript
// 导入工具函数
import { updateTasksUrgency } from '@/utils/taskUrgency'

// 加载时自动更新
const loadTasks = (): Task[] => {
  // ... 加载逻辑
  return updateTasksUrgency(parsedTasks)
}

// 定期检查（每5分钟）
onMounted(() => {
  urgencyCheckInterval = setInterval(
    () => {
      checkTasksUrgency()
    },
    5 * 60 * 1000,
  )

  // 窗口焦点事件
  window.addEventListener('focus', checkTasksUrgency)
})
```

#### `src/components/misson_l.vue`

```typescript
// addTask() - 添加任务时自动检查
let autoUrgent = newTask.urgent
if (newTask.deadline) {
  const remainingTime = newTask.deadline - Date.now()
  const twentyFourHours = 24 * 60 * 60 * 1000
  if (remainingTime < twentyFourHours) {
    autoUrgent = true
  }
}

// updateTask() - 更新任务时自动检查
// 同样的逻辑
```

#### `src/stores/tasksStore.ts`

虽然当前应用使用组件状态而非 Store，但 Store 中也已实现：

- `loadFromLocalStorage()` 加载后自动更新
- `addTask()` 添加时自动检查
- `updateTask()` 更新时自动检查
- `checkAndUpdateUrgency()` 手动触发方法

## 🧪 测试

### 单元测试

```bash
npm run test:unit -- src/utils/__tests__/taskUrgency.spec.ts
```

- ✅ 10/10 测试通过
- ✅ 无编译错误

### 手动测试场景

详见 `测试指南-任务自动紧急状态.md`

## 📊 调试信息

应用运行时，控制台会显示以下日志：

### 添加/编辑任务时

```
🔥 任务 "完成项目报告" 自动设为紧急 (剩余 8.50 小时)
```

### 定期检查时

```
🔍 检查任务紧急状态...
  🔥 "完成项目报告" 紧急状态: false → true
  ✅ "学习新技术" 紧急状态: true → false
✨ 2 个任务的紧急状态已更新
```

### 移除截止时间时

```
✅ 任务 "长期目标" 取消紧急状态（无截止时间）
```

## 🎯 使用方法

### 对用户透明

用户不需要做任何特殊操作，功能会自动生效：

1. **添加任务**：设置截止时间后，如果 < 24小时会自动标记为紧急
2. **编辑任务**：修改截止时间后自动重新判断
3. **持续监控**：应用会每5分钟检查一次，或在窗口获得焦点时检查

### 调试技巧

在浏览器控制台中：

```javascript
// 查看所有任务及其紧急状态
JSON.parse(localStorage.getItem('potato_tasks')).forEach((t) => {
  const remaining = t.deadline ? (t.deadline - Date.now()) / (1000 * 60 * 60) : Infinity
  console.log(`${t.urgent ? '🔥' : '⚪'} ${t.name}: ${remaining.toFixed(2)}小时`)
})

// 手动触发检查
// 在 Vue DevTools 中找到 App 组件，调用 checkTasksUrgency()
```

## 🐛 常见问题

### Q: 为什么我添加的任务没有自动标记为紧急？

A: 请检查：

1. 截止时间是否真的在24小时内
2. 浏览器控制台是否有相关日志
3. 确认没有其他 JavaScript 错误

### Q: 定时检查的频率可以调整吗？

A: 可以，在 `App.vue` 中修改：

```typescript
// 改为每10分钟检查一次
urgencyCheckInterval = setInterval(
  () => {
    checkTasksUrgency()
  },
  10 * 60 * 1000,
) // 10分钟
```

### Q: 如何关闭自动紧急功能？

A: 注释掉相关代码：

- `App.vue` 中的定时器和焦点监听
- `misson_l.vue` 中的 `autoUrgent` 逻辑

## 📈 性能考虑

- ✅ 使用防抖保存（500ms）避免频繁写入 localStorage
- ✅ 批量更新使用 map，性能良好
- ✅ 定时器在组件卸载时自动清理，无内存泄漏
- ✅ 只在必要时更新（检测到变化才触发重新渲染）

## 🚀 未来优化建议

1. **用户配置**：允许用户自定义紧急时间阈值（24小时 → 可配置）
2. **通知提醒**：任务变为紧急时显示系统通知
3. **渐进式紧急**：不同时间段显示不同紧急程度（12小时、6小时、1小时）
4. **统计分析**：追踪有多少任务错过了截止时间

## ✅ 验证清单

- [x] 核心逻辑正确（24小时判断）
- [x] 添加任务时自动检查
- [x] 编辑任务时自动检查
- [x] 页面加载时自动更新
- [x] 定期自动检查（5分钟）
- [x] 焦点恢复时检查
- [x] 单元测试全部通过
- [x] 无编译错误
- [x] 添加调试日志
- [x] 编写文档

## 🎊 完成！

功能已完全实现并经过测试。您现在可以：

1. 运行应用测试功能
2. 查看控制台日志验证行为
3. 使用测试指南进行手动测试
